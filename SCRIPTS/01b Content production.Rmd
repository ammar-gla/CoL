---
title:  "<br> Cost of Living indicators"
date: "`r format(Sys.Date(),'%B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    css:  !expr "here::here('FORMATTING','GLAstyle.css')"
    includes:
      in_header: !expr "here::here('FORMATTING','favicon.html')"
      before_body: !expr "here::here('FORMATTING','header.html')"
      after_body: !expr "here::here('FORMATTING','footer.html')"
---

```{r setup, include=FALSE}
  
  knitr::opts_chunk$set(echo = TRUE,scipen=999)
  knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
  
  #################################################################
  ###  Load packages and set paths
  #################################################################

  library("here") # To set project folder dynamically
  
    # Version of GLA theme for charting
  gla_theme_type <- "default"
  theme_set(theme_gla(gla_theme = gla_theme_type))
  
```

```{r, dates ,echo=FALSE}
  ### Create all the figures needed for the section below
  # Name format:
  # _d_: difference, _p_: difference in percent, _pp_: difference in percentage points, _uk: UK level stat, London otherwise
  
  # Paye
  paye_d_month <- value_form(pull_dtpt(dt=paye_stats,flt='date_day == max(date_day) & geography_name=="London" & measure_name=="emps"',vr="d_change_mom"),s= signif_thous)
  
  paye_p_month <- perc_form(pull_dtpt(dt=paye_stats,flt='date_day == max(date_day) & geography_name=="London" & measure_name=="emps"',vr="p_change_mom"),d = digits_perc)
  
  paye_previous_month <- paye_stats  %>% mutate(lag_month = lag(date_day, n = 1)) %>% mutate(lag_month2 = format(lag_month, '%B')) %>% filter( date_day == max(date_day)) %>%  pull(lag_month2)
  
  paye_p_feb20 <- perc_form(pull_dtpt(dt=paye_stats,flt='date_day == max(date_day) & geography_name=="London" & measure_name=="emps"',vr="p_change_feb20"),d = digits_perc)

  
  # CPIH
  
  cpih_last_month_form <- format(cpih_last_month,"%B %Y")

```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>
Contact: [Ammar Ljubijankic Kutasi](mailto:ammar.ljubijankic@london.gov.uk)
<!-- Summary of findings - MANUALLY ADJUST -->
<br/>

A collection of cost-of-living charts.

<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

## Nominal pay, inflation and real pay {.tabset}

### Annual real change


``` {r real annual change, echo=FALSE, out.width='100%',fig.cap = figure_cap}
pay_yoy_cpih_data <- cpih_pay_stats %>%
    select(date_day,cpih_yoy,p_change_yoy,geography_name,pay_type) %>%
  mutate(cpih_yoy=-cpih_yoy) %>% #to model impact from inflation
    pivot_longer(cols=contains("yoy"),names_to = "measure_name",values_to="measure_value") %>%
    mutate(measure_desc=case_when(measure_name=="p_change_yoy" & pay_type=="nominal" ~ "Nominal pay",
                                  measure_name=="p_change_yoy" & pay_type=="real" ~ "Real pay",
                                  measure_name=="cpih_yoy" ~ "CPIH"),
           measure_rank=case_when(measure_name=="p_change_yoy"  ~ 1,
                                  measure_name=="cpih_yoy" ~ 2))

  measure_order <- c("Nominal pay","Real pay","CPIH") #Ensuring right order of stacked bars
  named_groups <- c("Nominal pay","Real pay","CPIH")
  pal <- gla_pal(palette_type = "highlight",n=c(2,1)) 
  pal_named <- setNames(object=pal,nm=named_groups)
  
  real_nom_yoy_chart <- pay_yoy_cpih_data %>%
    filter(date_day>="2020-01-01" & date_day<=cpih_last_month & geography_name=="London") %>% 
    arrange(date_day,pay_type,measure_rank) %>% 
    ggplot(aes())  +
    geom_bar(data=. %>% filter(pay_type=="nominal"),
             aes(x = date_day, y = measure_value ,
                 colour=factor(measure_desc,levels = measure_order),
                 fill=factor(measure_desc,levels = measure_order),
                 text = paste0(format(date_day,'%B %Y'), "\n",
                           measure_desc,", effect on real pay: ", perc_form(100*measure_value,d=1),"%")),
             stat='identity',
             position="stack",
             width = 10)  +
    ggla_line(data=. %>% filter(pay_type=="real" & measure_name=="p_change_yoy"),
              aes(x = date_day, y = measure_value,
                  colour=measure_desc,
                 fill=measure_desc),
              size=1 * mm_to_pt)  +
    geom_point(data=. %>% filter(pay_type=="real" & measure_name=="p_change_yoy"),
              aes(x = date_day, y = measure_value,
                  colour=measure_desc,
                 fill=measure_desc,
                 text = paste0(format(date_day,'%B %Y'), "\n",
                           measure_desc,": ", perc_form(100*measure_value,d=1),"%")))+
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    scale_fill_manual(values=pal_named)+
    scale_colour_manual(values=pal_named)+
    coord_cartesian(clip = 'off') +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_y_continuous(expand = c(0, 0), labels = percent_format(accuracy = 1),
                       limits=c(-.12,.15)) +
    scale_x_date( date_breaks = "1 year",
                  date_labels = "%b %Y",
                  expand = expansion( mult = c(0.05,0.05))) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  "Decomposition of real median pay in London, % annual change",
         subtitle = paste0("Effect from nominal pay change and CPIH inflation, to ",cpih_last_month_form),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: March 2020 indicated by dotted line.\nInflation measure does not account for region-specific price changes. Sign of inflation rates has been \nreversed (higher inflation rates are associated with lower real pay growth).")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "real_nom_yoy_chart",w=10,h=8)
  
  # Plotly chart
  LMU_plotly_settings(ch_name = real_nom_yoy_chart,
                      title_text = 'paste0("Decomposition of real median pay in London, % annual change")',
                      subtitle_text = 'paste0("Effect from nominal pay change and CPIH inflation, to ",cpih_last_month_form)',
                      hover_mode = "closest")
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.","<br>","<br>", "Note: March 2020 indicated by dotted line. Inflation measure does not account for region-specific price changes. Sign of inflation rates has been reversed (higher inflation rates are associated with lower real pay growth).")
```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### Single-month changes

``` {r single month change, echo=FALSE, out.width='100%',fig.cap = figure_cap}
pay_mom_cpih_data <- cpih_pay_stats %>%
  select(date_day,cpih_mom,p_change_mom,geography_name,pay_type) %>%
  mutate(cpih_mom=-cpih_mom) %>% #to model impact from inflation
  pivot_longer(cols=contains("mom"),names_to = "measure_name",values_to="measure_value") %>%
  mutate(measure_desc=case_when(measure_name=="p_change_mom" & pay_type=="nominal" ~ "Nominal pay",
                                measure_name=="p_change_mom" & pay_type=="real" ~ "Real pay",
                                measure_name=="cpih_mom" ~ "CPIH"),
         measure_rank=case_when(measure_name=="p_change_mom"  ~ 1,
                                measure_name=="cpih_mom" ~ 2))

  measure_order <- c("Nominal pay","Real pay","CPIH") #Ensuring right order of stacked bars
  named_groups <- c("Nominal pay","Real pay","CPIH")
  pal <- gla_pal(palette_type = "highlight",n=c(2,1)) 
  pal_named <- setNames(object=pal,nm=named_groups)
  
  real_nom_mom_chart <- pay_mom_cpih_data %>%
    filter(date_day>="2020-01-01" & date_day<=cpih_last_month & geography_name=="London") %>% 
    arrange(date_day,pay_type,measure_rank) %>% 
    ggplot(aes())  +
    geom_bar(data=. %>% filter(pay_type=="nominal"),
             aes(x = date_day, y = measure_value ,
                 colour=factor(measure_desc,levels = measure_order),
                 fill=factor(measure_desc,levels = measure_order),
                 text = paste0(format(date_day,'%B %Y'), "\n",
                           measure_desc,", effect on real pay: ", perc_form(100*measure_value,d=1),"%")),
             stat='identity',
             position="stack",
             width = 10)  +
    ggla_line(data=. %>% filter(pay_type=="real" & measure_name=="p_change_mom"),
              aes(x = date_day, y = measure_value,
                  colour=measure_desc,
                 fill=measure_desc),
              size=1 * mm_to_pt)  +
    geom_point(data=. %>% filter(pay_type=="real" & measure_name=="p_change_mom"),
              aes(x = date_day, y = measure_value,
                  colour=measure_desc,
                 fill=measure_desc,
                 text = paste0(format(date_day,'%B %Y'), "\n",
                           measure_desc,": ", perc_form(100*measure_value,d=1),"%")))+
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    scale_fill_manual(values=pal_named)+
    scale_colour_manual(values=pal_named)+
    coord_cartesian(clip = 'off') +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_y_continuous(expand = c(0, 0), labels = percent_format(accuracy = 1),
                       limits=c(-.03,.03)) +
    scale_x_date( date_breaks = "1 year",
                  date_labels = "%b %Y",
                  expand = expansion( mult = c(0.05,0.05))) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  "Decomposition of real median pay in London, % monthly change",
         subtitle = paste0("Effect from nominal pay change and CPIH inflation, to ",cpih_last_month_form),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: March 2020 indicated by dotted line.\nInflation measure does not account for region-specific price changes. Sign of inflation rates has been \nreversed (higher inflation rates are associated with lower real pay growth).")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "real_nom_mom_chart")
  
  # Plotly chart
  LMU_plotly_settings(ch_name = real_nom_mom_chart,
                      title_text = 'paste0("Decomposition of real median pay in London, % monthly change")',
                      subtitle_text = 'paste0("Effect from nominal pay change and CPIH inflation, to ",cpih_last_month_form)',
                      hover_mode = "closest")
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.","<br>","<br>", "Note: March 2020 indicated by dotted line. Inflation measure does not account for region-specific price changes. Sign of inflation rates has been reversed (higher inflation rates are associated with lower real pay growth).")

```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### Three-month changes


``` {r three month change, echo=FALSE, out.width='100%',fig.cap = figure_cap}

pay_3o3_cpih_data <- cpih_pay_stats %>%
  select(date_day,date_3m,cpih_3o3,p_change_3o3,geography_name,pay_type) %>%
  mutate(cpih_3o3=-cpih_3o3) %>% #to model impact from inflation
  pivot_longer(cols=contains("3o3"),names_to = "measure_name",values_to="measure_value") %>%
  mutate(measure_desc=case_when(measure_name=="p_change_3o3" & pay_type=="nominal" ~ "Nominal pay",
                                measure_name=="p_change_3o3" & pay_type=="real" ~ "Real pay",
                                measure_name=="cpih_3o3" ~ "CPIH"),
         measure_rank=case_when(measure_name=="p_change_3o3"  ~ 1,
                                measure_name=="cpih_3o3" ~ 2))

  measure_order <- c("Nominal pay","Real pay","CPIH") #Ensuring right order of stacked bars
  named_groups <- c("Nominal pay","Real pay","CPIH")
  pal <- gla_pal(palette_type = "highlight",n=c(2,1)) 
  pal_named <- setNames(object=pal,nm=named_groups)
  
  real_nom_3o3_chart <- pay_3o3_cpih_data %>%
    filter(date_day>="2020-01-01" & date_day<=cpih_last_month & geography_name=="London") %>% 
    arrange(date_day,pay_type,measure_rank) %>% 
    ggplot(aes())  +
    geom_bar(data=. %>% filter(pay_type=="nominal"),
             aes(x = date_day, y = measure_value ,
                 colour=factor(measure_desc,levels = measure_order),
                 fill=factor(measure_desc,levels = measure_order),
                 text = paste0(date_3m, "\n",
                           measure_desc,", effect on real pay: ", perc_form(100*measure_value,d=1),"%")),
             stat='identity',
             position="stack",
             width = 10)  +
    ggla_line(data=. %>% filter(pay_type=="real" & measure_name=="p_change_3o3"),
              aes(x = date_day, y = measure_value,
                  colour=measure_desc,
                 fill=measure_desc),
              size=1 * mm_to_pt)  +
    geom_point(data=. %>% filter(pay_type=="real" & measure_name=="p_change_3o3"),
              aes(x = date_day, y = measure_value,
                  colour=measure_desc,
                 fill=measure_desc,
                 text = paste0(date_3m, "\n",
                           measure_desc,": ", perc_form(100*measure_value,d=1),"%")))+
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    scale_fill_manual(values=pal_named)+
    scale_colour_manual(values=pal_named)+
    coord_cartesian(clip = 'off') +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_y_continuous(expand = c(0, 0), labels = percent_format(accuracy = 1),
                       limits=c(-.04,.06)) +
    scale_x_date( date_breaks = "1 year",
                  date_labels = "%b %Y",
                  expand = expansion( mult = c(0.05,0.05))) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  "Decomposition of real median pay in London, 3-month period % change",
         subtitle = paste0("Effect from nominal pay change and CPIH inflation, to ",cpih_last_month_form),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: March 2020 indicated by dotted line.\nInflation measure does not account for region-specific price changes. Sign of inflation rates has been \nreversed (higher inflation rates are associated with lower real pay growth).")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "real_nom_3o3_chart")
  
  # Plotly chart
  LMU_plotly_settings(ch_name = real_nom_3o3_chart,
                      title_text = 'paste0("Decomposition of real median pay in London, 3-month period % change")',
                      subtitle_text = 'paste0("Effect from nominal pay change and CPIH inflation, to ",cpih_last_month_form)',
                      hover_mode = "closest")
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.","<br>","<br>", "Note: March 2020 indicated by dotted line. Inflation measure does not account for region-specific price changes. Sign of inflation rates has been reversed (higher inflation rates are associated with lower real pay growth).")

```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

## Annualised changes {.tabset}

### Nominal pay

``` {r annualised nom pay, echo=FALSE, out.width='100%',fig.cap = figure_cap}


  pay_annu_data <- cpih_pay_stats %>%
    filter(date_day>=as.Date("2019-01-01") & geography_name=="London") %>% 
  select(date_day,geography_pay_type,contains("annualised"),p_change_yoy,cpih_yoy) %>% 
  pivot_longer(cols=c(contains(c("annualised_1m","annualised_3m")),p_change_yoy,cpih_yoy),names_to = "measure_name",values_to = "measure_value") %>% 
  mutate(measure_type = case_when(grepl("cpih",measure_name) ~ "CPIH",
                                  TRUE ~ geography_pay_type),
         measure_name = case_when(measure_name=="p_change_yoy" ~ "12 month change",
                                  measure_name=="p_annualised_1m" ~ "1 month annualised",
                                  measure_name=="p_annualised_3m" ~ "3 month annualised",
                                  measure_name=="cpih_yoy" ~ "12 month change",
                                  measure_name=="cpih_annualised_1m" ~ "1 month annualised",
                                  measure_name=="cpih_annualised_3m" ~ "3 month annualised")) %>% 
  arrange(date_day,measure_type)
  
  named_groups <- c("12 month change","1 month annualised","3 month annualised")
  pal <- gla_pal(palette_type = "categorical",n=3) 
  pal_named <- setNames(object=pal,nm=named_groups)

  
  nom_pay_annual <- pay_annu_data %>% 
    filter(measure_type=="London, nominal") %>% 
        ggplot(aes())+
    geom_point( #trick to make date appear separately and only once
      show.legend = FALSE,
      aes(x = date_day, 
          y = 0 ,
          group="1",
          text = paste0(
            format(date_day,"%B %Y"))),
      colour=NA)   + 
    ggla_line(aes(x = date_day, y = measure_value, 
                                colour = factor(measure_name, levels=named_groups), 
                                group = factor(measure_name, levels=named_groups),
                                text = paste0(
                                  measure_name, "\n",
                                  "Change: ", perc_form(100*measure_value),"%")),
              size=1 * mm_to_pt)   +
    scale_colour_manual(values = pal_named) +
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    geom_hline(aes(yintercept=0), colour="gray45") +
    coord_cartesian(clip = 'off') +
    scale_y_continuous(expand = c(0, 0), 
                       labels = percent_format(accuracy=1)) +
    scale_x_date( date_breaks = "1 year",
                  date_labels = "%b %Y",
                  expand = expansion( mult = c(0.05,0.05))) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  "Yearly change in payrolled employees nominal median pay (%)",
         subtitle = paste0("Latest data to ",cpih_last_month_form),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: March 2020 indicated by dotted line.")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "nom_pay_annual")
  
  LMU_plotly_settings(ch_name = nom_pay_annual,
                      title_text = 'paste0("Yearly change in payrolled employees nominal median pay (%)")',
                      subtitle_text = 'paste0("Latest data to ",cpih_last_month_form)',
                      hover_mode = "x unified") 
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.","<br>","<br>", "Note: .")
  
```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### CPIH

``` {r annualised cpih, echo=FALSE, out.width='100%',fig.cap = figure_cap}

  named_groups <- c("YoY change","1 month annualised","3 month annualised")
  pal <- gla_pal(palette_type = "categorical",n=3) 
  pal_named <- setNames(object=pal,nm=named_groups)

  
  cpih_annual <- pay_annu_data %>% 
    filter(measure_type=="CPIH") %>% 
    ggplot(aes())+
    geom_point( #trick to make date appear separately and only once
      show.legend = FALSE,
      aes(x = date_day, 
          y = 0 ,
          group="1",
          text = paste0(
            format(date_day,"%B %Y"))),
      colour=NA)   + 
    ggla_line(aes(x = date_day, y = measure_value, 
                                colour = factor(measure_name, levels=named_groups), 
                                group = factor(measure_name, levels=named_groups),
                                text = paste0(
                                  measure_name, "\n",
                                  "Change: ", perc_form(100*measure_value),"%")),
              size=1 * mm_to_pt)   +
    scale_colour_manual(values = pal_named) +
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    geom_hline(aes(yintercept=0), colour="gray45") +
    coord_cartesian(clip = 'off') +
    scale_y_continuous(expand = c(0, 0), 
                       labels = percent_format(accuracy=1)) +
    scale_x_date( date_breaks = "1 year",
                  date_labels = "%b %Y",
                  expand = expansion( mult = c(0.05,0.05))) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  "Yearly change in CPIH inflation rate (%)",
         subtitle = paste0("Latest data to ",cpih_last_month_form),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: March 2020 indicated by dotted line.")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "cpih_annual")
  
  LMU_plotly_settings(ch_name = cpih_annual,
                      title_text = 'paste0("Yearly change in CPIH inflation rate (%)")',
                      subtitle_text = 'paste0("Latest data to ",cpih_last_month_form)',
                      hover_mode = "x unified") 
  
  figure_cap <- paste0("Source: ONS.","<br>","<br>", "Note: .")
  
```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>


### Real pay

``` {r annualised real pay, echo=FALSE, out.width='100%',fig.cap = figure_cap}

  named_groups <- c("YoY change","1 month annualised","3 month annualised")
  pal <- gla_pal(palette_type = "categorical",n=3) 
  pal_named <- setNames(object=pal,nm=named_groups)

  
  real_pay_annual <- pay_annu_data %>% 
    filter(measure_type=="London, real") %>% 
    ggplot(aes())+
    geom_point( #trick to make date appear separately and only once
      show.legend = FALSE,
      aes(x = date_day, 
          y = 0 ,
          group="1",
          text = paste0(
            format(date_day,"%B %Y"))),
      colour=NA)   + 
    ggla_line(aes(x = date_day, y = measure_value, 
                                colour = factor(measure_name, levels=named_groups), 
                                group = factor(measure_name, levels=named_groups),
                                text = paste0(
                                  measure_name, "\n",
                                  "Change: ", perc_form(100*measure_value),"%")),
              size=1 * mm_to_pt)   +
    scale_colour_manual(values = pal_named) +
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    geom_hline(aes(yintercept=0), colour="gray45") +
    coord_cartesian(clip = 'off') +
    scale_y_continuous(expand = c(0, 0), 
                       labels = percent_format(accuracy=1)) +
    scale_x_date( date_breaks = "1 year",
                  date_labels = "%b %Y",
                  expand = expansion( mult = c(0.05,0.05))) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  "Yearly change in payrolled employees real pay (%)",
         subtitle = paste0("Latest data to ",cpih_last_month_form),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: March 2020 indicated by dotted line.")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "real_pay_annual")
  
  LMU_plotly_settings(ch_name = real_pay_annual,
                      title_text = 'paste0("Yearly change in payrolled employees real pay (%)")',
                      subtitle_text = 'paste0("Latest data to ",cpih_last_month_form)',
                      hover_mode = "x unified") 
  
  figure_cap <- paste0("Source: ONS.","<br>","<br>", "Note: .")
  
```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>


## Industry level {.tabset}

### Change since Feb 2020

``` {r industry change, echo=FALSE, out.width='100%',fig.cap = figure_cap}
  
  # Set size threshold
  sector_thresh <- 25000
  
  pal <- setNames(gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1)),
                  nm=c("London","UK"))
  
  # Select industries large in London, e.g. 20k+
  lon_large_inds_paye <- paye_nuts1ind_stats %>%
    filter( geography_name=="London" & date_day == paye_ind_last_date & measure_name == "emps" & measure_value>=sector_thresh) %>% 
    pull(industry_name_simple)
  
  paye_ind_pay_feb20 <- paye_nuts1ind_stats %>%
    filter(date_day == paye_ind_last_date & measure_name == "median_pay" & industry_name_simple %in% lon_large_inds_paye & geography_name %in% c("London", "UK")) %>% 
    group_by(geography_name) %>% #To ensure chart ranking is correct, make rank based on London and assign within sector
    mutate(chart_ranking = case_when( 
      industry_name_simple == "Total" & geography_name=="London" ~ 1,
      !(industry_name_simple == "Total") & geography_name=="London" ~ dense_rank(desc(p_change_feb20))+1,
      TRUE ~ 99))  %>% 
    group_by(industry_name_simple) %>% 
    mutate(chart_ranking=min(chart_ranking)) %>% 
    ungroup() %>% 
    arrange(chart_ranking)   %>% 
    ggplot(mapping = aes(x =  factor(reorder(industry_name_simple, -chart_ranking)), 
                         y = p_change_feb20, 
                         colour = factor(reorder(geography_name,desc(geography_name))) ,#since horizontal bar reverses orders, we need to reverse too
                         fill=factor(reorder(geography_name,desc(geography_name))),
                         text = paste0(industry_name_simple, "\n",
                                      geography_name, "\n",
                                      "Change: ", perc_form(100*p_change_feb20),"%", "\n"))) +
    geom_bar(stat = "identity", position = position_dodge(), width=0.5) +
    geom_hline(aes(yintercept=0), colour="gray45") +
    geom_vline(xintercept=c(length(lon_large_inds_paye) - 0.5),
               colour="gray45",
               linetype = "dotted",
               size = 1 * mm_to_pt)+ #adds line below total
    scale_color_manual(values = rev(pal), aesthetics = "colour")+
    scale_fill_manual(values = rev(pal), aesthetics = "fill")+
    theme_set(theme_gla(gla_theme = "default", y_label_length=100)) + #GLA theme and removes lines below y-axis labels
    scale_y_continuous(limits = c(-0.02, 0.4), 
                       labels = percent_format(accuracy=1)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    scale_x_discrete(expand = c(0,0)) +
    theme(panel.grid.major.y = element_blank(), #removed y grid
          panel.grid.minor.y = element_blank(), # removes small y grid
          panel.grid.major.x = element_line( size=.5 ), # removes x grid
          axis.text.y = ggplot2::element_text( # ensures  y axis labels stay outside chart
            hjust = 0, vjust = 0.5,
            margin = ggplot2::margin(t = 0, r = 0, b = 0, l = 0,
                                     unit = "pt")),
          axis.ticks.length.y = ggplot2::unit(x = 0, units = "pt")) + #removes ticks from y axis
    coord_flip()+
    guides(colour=guide_legend(reverse=TRUE),
           fill=guide_legend(reverse=TRUE)) +
    labs(title = paste0("Nominal median pay by industry, % change"),
         subtitle = paste0("Payrolled employee pay, between February 2020 and ", paye_ind_last_month),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: ")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye_ind_pay_feb20")
  
  LMU_plotly_settings(ch_name = paye_ind_pay_feb20,
                      title_text = 'paste0("Nominal median pay by industry, % change")',
                      subtitle_text = 'paste0("Payrolled employee pay, between February 2020 and ", paye_ind_last_month)',
                      hover_mode = "closest") %>% 
    layout(xaxis = list(showgrid=TRUE),
           yaxis = list(showgrid=FALSE)) %>% 
    reverse_legend_labels()
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.","<br>","<br>", "Note: .")

```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>


### Change on year

``` {r industry change yoy, echo=FALSE, out.width='100%',fig.cap = figure_cap}
  
  pal <- setNames(gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1)),
                  nm=c("London","UK"))

  paye_ind_pay_yoy <- paye_nuts1ind_stats %>%
    filter(date_day == paye_ind_last_date & measure_name == "median_pay" & industry_name_simple %in% lon_large_inds_paye & geography_name %in% c("London", "UK")) %>% 
    group_by(geography_name) %>% #To ensure chart ranking is correct, make rank based on London and assign within sector
    mutate(chart_ranking = case_when( 
      industry_name_simple == "Total" & geography_name=="London" ~ 1,
      !(industry_name_simple == "Total") & geography_name=="London" ~ dense_rank(desc(p_change_yoy))+1,
      TRUE ~ 99))  %>% 
    group_by(industry_name_simple) %>% 
    mutate(chart_ranking=min(chart_ranking)) %>% 
    ungroup() %>% 
    arrange(chart_ranking)   %>% 
    ggplot(mapping = aes(x =  factor(reorder(industry_name_simple, -chart_ranking)), 
                         y = p_change_yoy, 
                         colour = factor(reorder(geography_name,desc(geography_name))) ,#since horizontal bar reverses orders, we need to reverse too
                         fill=factor(reorder(geography_name,desc(geography_name))),
                         text = paste0(industry_name_simple, "\n",
                                      geography_name, "\n",
                                      "Change: ", perc_form(100*p_change_yoy),"%", "\n"))) +
    geom_bar(stat = "identity", position = position_dodge(), width=0.5) +
    geom_hline(aes(yintercept=0), colour="gray45") +
    geom_vline(xintercept=c(length(lon_large_inds_paye) - 0.5),
               colour="gray45",
               linetype = "dotted",
               size = 1 * mm_to_pt)+ #adds line below total
    scale_color_manual(values = rev(pal), aesthetics = "colour")+
    scale_fill_manual(values = rev(pal), aesthetics = "fill")+
    theme_set(theme_gla(gla_theme = "default", y_label_length=100)) + #GLA theme and removes lines below y-axis labels
    scale_y_continuous(limits = c(0, 0.2), 
                       labels = percent_format(accuracy=1)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    scale_x_discrete(expand = c(0,0)) +
    theme(panel.grid.major.y = element_blank(), #removed y grid
          panel.grid.minor.y = element_blank(), # removes small y grid
          panel.grid.major.x = element_line( size=.5 ), # removes x grid
          axis.text.y = ggplot2::element_text( # ensures  y axis labels stay outside chart
            hjust = 0, vjust = 0.5,
            margin = ggplot2::margin(t = 0, r = 0, b = 0, l = 0,
                                     unit = "pt")),
          axis.ticks.length.y = ggplot2::unit(x = 0, units = "pt")) + #removes ticks from y axis
    coord_flip()+
    guides(colour=guide_legend(reverse=TRUE),
           fill=guide_legend(reverse=TRUE)) +
    labs(title = paste0("Nominal median pay by industry, % change on year"),
         subtitle = paste0("Payrolled employee pay, ", paye_ind_last_month),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: ")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye_ind_pay_yoy")
  
  LMU_plotly_settings(ch_name = paye_ind_pay_yoy,
                      title_text = 'paste0("Nominal median pay by industry, % change on year")',
                      subtitle_text = 'paste0("Payrolled employee pay, ", paye_ind_last_month)',
                      hover_mode = "closest") %>% 
    layout(xaxis = list(showgrid=TRUE),
           yaxis = list(showgrid=FALSE)) %>% 
    reverse_legend_labels()
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.","<br>","<br>", "Note: .")

```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### Median salary level

``` {r industry pay level, echo=FALSE, out.width='100%',fig.cap = figure_cap}

  pal <- setNames(gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1)),
                  nm=c("London","UK"))
  
  # Chart  
  paye_ind_pay_level <- paye_nuts1ind_stats %>%
    filter(date_day == paye_ind_last_date & measure_name == "median_pay" & 
             industry_name_simple %in% lon_large_inds_paye & geography_name %in% c("London", "UK")) %>% 
    group_by(geography_name) %>% #To ensure chart ranking is correct, make rank based on London and assign within sector
    mutate(chart_ranking = case_when( 
      industry_name_simple == "Total" & geography_name=="London" ~ 1,
      !(industry_name_simple == "Total") & geography_name=="London" ~ dense_rank(desc(measure_value))+1,
      TRUE ~ 99))  %>% 
    group_by(industry_name_simple) %>% 
    mutate(chart_ranking=min(chart_ranking)) %>% 
    ungroup() %>% 
    arrange(chart_ranking)   %>% 
    ggplot(mapping = aes(x =  factor(reorder(industry_name_simple, -chart_ranking)), 
                         y = measure_value, 
                         colour = factor(reorder(geography_name,desc(geography_name))) ,#since horizontal bar reverses orders, we need to reverse too
                         fill=factor(reorder(geography_name,desc(geography_name))),
                         text = paste0(industry_name_simple, "\n",
                                       geography_name, "\n",
                                       "Median pay: ", "£", value_form(measure_value), "\n"))) +
    geom_bar(stat = "identity", position = position_dodge(), width=0.5) +
    geom_hline(aes(yintercept=0), colour="gray45") +
    geom_vline(xintercept=c(length(lon_large_inds_paye) - 0.5),
               colour="gray45",
               linetype = "dotted",
               size = 1 * mm_to_pt)+ #adds line below total
    scale_color_manual(values = rev(pal), aesthetics = "colour")+
    scale_fill_manual(values = rev(pal), aesthetics = "fill")+
    theme_set(theme_gla(gla_theme = "default", y_label_length=100)) + #GLA theme and removes lines below y-axis labels
    scale_y_continuous(labels = comma_format(prefix = "£")) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    scale_x_discrete(expand = c(0,0)) +
    theme(panel.grid.major.y = element_blank(), #removed y grid
          panel.grid.minor.y = element_blank(), # removes small y grid
          panel.grid.major.x = element_line( size=.5 ), # removes x grid
          axis.text.y = ggplot2::element_text( # ensures  y axis labels stay outside chart
            hjust = 0, vjust = 0.5,
            margin = ggplot2::margin(t = 0, r = 0, b = 0, l = 0,
                                     unit = "pt")),
          axis.ticks.length.y = ggplot2::unit(x = 0, units = "pt")) + #removes ticks from y axis
    coord_flip()+
    guides(colour=guide_legend(reverse=TRUE),
           fill=guide_legend(reverse=TRUE)) +
    labs(title = paste0("Nominal median pay by industry"),
         subtitle = paste0("Payrolled employee pay, ", paye_ind_last_month),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: ")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye_ind_pay_level")
  
  LMU_plotly_settings(ch_name = paye_ind_pay_level,
                      title_text = 'paste0("Nominal median pay by industry")',
                      subtitle_text = 'paste0("Payrolled employee pay, ", paye_ind_last_month)',
                      hover_mode = "closest") %>% 
    layout(xaxis = list(showgrid=TRUE),
           yaxis = list(showgrid=FALSE)) %>% 
    reverse_legend_labels()

  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.","<br>","<br>", "Note: .")

```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>


## Industries cross-variable trends {.tabset}

### Pay growth vs. level

``` {r, paye ind pay trend, echo=FALSE, out.width='100%',fig.cap = figure_cap}


  # select month which to use as comparison level, e.g. February 2020
  paye_ind_pay_comp_month <- as.Date("2020-02-01")
  paye_ind_pay_comp_month_form <- format(paye_ind_pay_comp_month,"%B %Y")
  
  # Need employee and pay stats simultaneously so reshape wide
  
  paye_nuts1ind_bubble_stats <- paye_nuts1ind_stats %>% 
    group_by(industry_name_simple,industry_name,geography_name,measure_name) %>% # for within-industry stats
    mutate(measure_value_comp_month = measure_value[date_day==paye_ind_pay_comp_month],
           measure_value_latest = measure_value[date_day==paye_ind_last_date]) %>% 
    group_by(geography_name,date_day,measure_name)  %>% 
    mutate(measure_share = measure_value/measure_value[industry_name_simple=="Total"]) %>% 
    ungroup() %>% 
    pivot_wider(names_from=measure_name,
                values_from = c(contains("measure_value"),p_change_feb20,p_change_yoy,index_feb20,measure_share),
                names_glue = "{measure_name}_{.value}") %>% 
    arrange(date_day,geography_name,industry_name_simple)
  
  # Chart functions
  pal <- gla_pal(n=1)
  pal_lines <- gla_pal(n=1,main_colours = "ldnpink")
  
  # Bubbles are size of industry employees, values are growth vs. level in pay
  # Have straight lines indicate London averages
  paye_ind_pay_v_pay <- paye_nuts1ind_bubble_stats %>% 
    filter(date_day==paye_ind_last_date & geography_name=="London" & emps_measure_share>=0.01) %>% 
    ggplot() +
    geom_point(data = . %>% filter(industry_name_simple != "Total"),
               aes(x=median_pay_measure_value_comp_month,
                   y=median_pay_p_change_feb20,
                   size=emps_measure_value,
                   text= paste0(industry_name_simple,"\n",
                                "Feb '20 pay level: £",value_form(median_pay_measure_value_comp_month),"\n",
                                "Pay growth: ",perc_form(100*median_pay_p_change_feb20),"%","\n",
                                "Employees: ",value_form(emps_measure_value))),
               color=pal,
               fill=pal,
               alpha=0.6)+
    scale_size(range = c(3, 15)) +
    geom_vline(data = . %>% filter(industry_name_simple == "Total"),
               aes(xintercept = median_pay_measure_value_comp_month),
               size = 1 * mm_to_pt,
               colour = pal_lines) + # median london wage
    geom_hline(data = . %>% filter(industry_name_simple == "Total"),
               aes(yintercept = median_pay_p_change_feb20),
               size = 1 * mm_to_pt,
               colour = pal_lines) + # median london wage change
    coord_cartesian(clip = 'off') +
    scale_y_continuous(expand = expansion( mult = c(0,0.05)), 
                       labels = percent_format(accuracy = 1),
                       limits = c(-0.05,0.25)) +
    scale_x_continuous(expand = expansion( mult = c(0.05,0.05)),
                       labels = comma_format(prefix = "£")) +
    theme(legend.position = "none",
          plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  paste0("Median pay level vs. median pay growth, ",paye_ind_pay_comp_month_form,", London"),
         subtitle = paste0("Growth to ",paye_ind_last_month,"; bubble size represents size of sector"),
         caption = paste0("\nSource: HM Revenue and Customs - Pay As You Earn Real Time Information.",
                          "\n\nNote: Estimates are based on where employees live.",
                          " Excludes sectors with less than 1% of workforce.",
                          "\nVertical line indicates level of median pay in London in ",paye_ind_pay_comp_month_form,",",
                          "\nhorizontal line indicates change in London median pay ",paye_ind_pay_comp_month_form,"-",paye_ind_last_month))+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  # Add text labels separately as plotly does not support them
  paye_ind_pay_v_pay_static <- paye_ind_pay_v_pay +
    geom_text_repel(data = . %>% filter(industry_name_simple != "Total"),
                    aes(x=median_pay_measure_value_comp_month,
                        y=median_pay_p_change_feb20,
                        label = industry_name_simple),
                    seed=1,
                    box.padding   = 0.8, 
                    point.padding = 0.6,
                    segment.color = 'grey50')
  
  
  # Save chart
  save_GLA_plot(plot_name = "paye_ind_pay_v_pay_static",w=10, h=7)
  
  # Plotly chart
  LMU_plotly_settings(ch_name = paye_ind_pay_v_pay,
                      title_text = 'paste0("Median pay level vs. median pay growth, ",paye_ind_pay_comp_month_form,", London")',
                      subtitle_text = 'paste0("Growth to ",paye_ind_last_month,"; bubble size represents size of sector")',
                      hover_mode = "closest")
  
  figure_cap <- paste0("Source: HM Revenue and Customs - Pay As You Earn Real Time Information.",
                          "<br>","<br>",
                       "Note: Estimates are based on where employees live. Excludes sectors with less than 1% of workforce.",
                          "<br>",
                       "Vertical line indicates level of median pay in London in ",paye_ind_pay_comp_month_form,",",
                          "<br>",
                       "horizontal line indicates change in London median pay ",paye_ind_pay_comp_month_form,"-",paye_ind_last_month)

#### Save csv file of data for publication replication by Daryl
# 
# paye_nuts1ind_save <- paye_nuts1ind_charting %>%
#   filter(date_day==max(date_day) & geography_name=="London") %>%
#   select(industry_name_simple,level_pay_comp_month,p_change_feb20_pay,level_pay_comp_month,level_emp_latest,level_pay_london_comp_month,p_change_feb20_pay_london) %>%
#   fwrite(file = paste0(INTERMEDIATE,Sys.Date(),"_median_vs_growth.csv"))


```

<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>


### Emp growth vs pay growth

``` {r, paye ind pay_emp trend, echo=FALSE, out.width='100%',fig.cap = figure_cap}


# Chart functions
pal <- gla_pal(n=1)
pal_lines <- gla_pal(n=1,main_colours = "ldnpink")

# Bubbles are size of industry employees, values are growth vs. level in pay
# Have straight lines indicate London averages
paye_ind_emp_v_pay <- paye_nuts1ind_bubble_stats %>% 
  filter(date_day==paye_ind_last_date & geography_name=="London" & emps_measure_share>=0.01) %>% 
  ggplot() +
  geom_point(data = . %>% filter(industry_name_simple != "Total"),
             aes(x=emps_p_change_feb20,
                 y=median_pay_p_change_feb20,
                 size=emps_measure_value,
                   text= paste0(industry_name_simple,"\n",
                                "Employee growth: ",perc_form(100*emps_p_change_feb20),"%","\n",
                                "Pay growth: ",perc_form(100*median_pay_p_change_feb20),"%","\n",
                                "Employees: ",value_form(emps_measure_value))),
             color=pal,
             fill=pal,
             alpha=0.6)+
  scale_size(range = c(3, 15)) +
  geom_vline(data = . %>% filter(industry_name_simple == "Total"),
             aes(xintercept = emps_p_change_feb20),
             size = 1 * mm_to_pt,
             colour = pal_lines) + # median london wage
  geom_hline(data = . %>% filter(industry_name_simple == "Total"),
             aes(yintercept = median_pay_p_change_feb20),
             size = 1 * mm_to_pt,
             colour = pal_lines) + # median london wage change
  coord_cartesian(clip = 'off') +
  scale_y_continuous(expand = expansion( mult = c(0,0.05)), 
                     labels = percent_format(accuracy = 1),
                     limits = c(-0.05,0.25)) +
  scale_x_continuous(expand = expansion( mult = c(0.05,0.05)),
                     labels = percent_format(accuracy = 1)) +
  theme(legend.position = "none",
        plot.margin = unit(c(1,1,1,1), "cm"))+
  labs(title =  paste0("Employee growth vs. median pay growth, London"),
       subtitle = paste0("Growth from ",paye_ind_pay_comp_month_form, " to ",paye_ind_last_month ,"; bubble size represents size of sector"),
       caption = paste0("\nSource: HM Revenue and Customs - Pay As You Earn Real Time Information.",
                        "\n\nNote: Estimates are based on where employees live. Excludes sectors with less than 1% of workforce.",
                        "\nVertical line indicates change in London employees ",paye_ind_pay_comp_month_form,"-",paye_ind_last_month,",",
                        "\nhorizontal line indicates change in London median pay ",paye_ind_pay_comp_month_form,"-",paye_ind_last_month))+
  theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))

  # Add text labels separately as plotly does not support them
  paye_ind_emp_v_pay_static <- paye_ind_emp_v_pay +
    geom_text_repel(data = . %>% filter(industry_name_simple != "Total"),
                    aes(x=emps_p_change_feb20,
                        y=median_pay_p_change_feb20,
                        label = industry_name_simple),
                    seed=1,
                    box.padding   = 0.8, 
                    point.padding = 0.6,
                    segment.color = 'grey50')

# Save chart
save_GLA_plot(plot_name = "paye_ind_emp_v_pay_static",w=12, h=5)

  
  # Plotly chart
  LMU_plotly_settings(ch_name = paye_ind_emp_v_pay,
                      title_text = 'paste0("Employee growth vs. median pay growth, London")',
                      subtitle_text = 'paste0("Growth from ",paye_ind_pay_comp_month_form, " to ",paye_ind_last_month ,"; bubble size represents size of sector")',
                      hover_mode = "closest")
  
  figure_cap <- paste0("Source: HM Revenue and Customs - Pay As You Earn Real Time Information.",
                          "<br>","<br>",
                       "Note: Estimates are based on where employees live. Excludes sectors with less than 1% of workforce.",
                          "<br>",
                       "Vertical line indicates change in London employees ",paye_ind_pay_comp_month_form,"-",paye_ind_last_month,",",
                          "<br>",
                       "horizontal line indicates change in London median pay ",paye_ind_pay_comp_month_form,"-",paye_ind_last_month)

#### Save csv file of data for publication replication by Daryl
# 
# paye_nuts1ind_save <- paye_nuts1ind_charting %>%
#   filter(date_day==max(date_day) & geography_name=="London") %>%
#   select(industry_name_simple,level_pay_comp_month,p_change_feb20_pay,level_pay_comp_month,level_emp_latest,level_pay_london_comp_month,p_change_feb20_pay_london) %>%
#   fwrite(file = paste0(INTERMEDIATE,Sys.Date(),"_median_vs_growth.csv"))


```

<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>


## Local authority {.tabset}

### Change since February 2020

``` {r la change, echo=FALSE, out.width='100%',fig.cap = figure_cap}

    # Produces interactive and static map of boroughs with change in payrolled employees
    
  ## The below produces both a markdown interactive Leaflet map and a static GGPLOT map ##
paye_la_pay_map_data <- paye_la_stats_geo %>% 
    filter(measure_name=="median_pay")

  # All necessary variables for map
  map_title <- paste0("Nominal pay, change (%)","<br>" ,"since February 2020")
  map_title_static <- paste0("Nominal median pay, % change since February 2020")
  figure_cap <- paste0("Source: HM Revenue and Customs - Pay As You Earn Real Time Information. Contains Ordnance Survey data Crown copyright and database rights [2015].","<br>","<br>", "Note: Estimates are based on where employees live.")
  
  # Run static map
  paye_la_pay_feb20_map <- ggplot_map_output(dataset=paye_la_pay_map_data,
                                       dt_var="p_change_feb20",
                                       bin_rounding = 2,
                                       diverge_scale = FALSE,
                                       pal_colour = "blue",
                                       title=map_title_static,
                                       perc_bin = TRUE,
                                       chart_name="paye_la_pay_feb20_map",
                                       caption_txt=figure_cap)
  
  # Run interactive map and output to markdown
  leaflet_map_output(dataset=paye_la_pay_map_data,
                     dt_var="p_change_feb20",
                     bin_rounding = 2,
                     diverge_scale = FALSE,
                     pal_colour ="blue",
                     title=map_title,
                     perc_bin = TRUE)
  
```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### Change on year

``` {r la change yoy, echo=FALSE, out.width='100%',fig.cap = figure_cap}

    # Produces interactive and static map of boroughs with change in payrolled employees
  paye_la_pay_yoy_map_data <- paye_la_pay_map_data %>% 
    mutate(tooltip= paste0("Change: ", perc_form(p_change_yoy),"%", "\n"))
  ## The below produces both a markdown interactive Leaflet map and a static GGPLOT map ##


  # All necessary variables for map
  map_title <- paste0("Nominal median pay","<br>" ,"change on year (%)")
  map_title_static <- paste0("Nominal median pay, % change on year")
  figure_cap <- paste0("Source: HM Revenue and Customs - Pay As You Earn Real Time Information. Contains Ordnance Survey data Crown copyright and database rights [2015].","<br>","<br>", "Note: Estimates are based on where employees live.")
  
  # Run static map
  paye_la_pay_yoy_map <- ggplot_map_output(dataset=paye_la_pay_yoy_map_data,
                                       dt_var="p_change_yoy",
                                       bin_rounding = 2,
                                       diverge_scale = FALSE,
                                       pal_colour = "blue",
                                       title=map_title_static,
                                       perc_bin = TRUE,
                                       chart_name="paye_la_pay_yoy_map",
                                       caption_txt=figure_cap)
  
  # Run interactive map and output to markdown
  leaflet_map_output(dataset=paye_la_pay_yoy_map_data,
                     dt_var="p_change_yoy",
                     bin_rounding = 2,
                     diverge_scale = FALSE,
                     pal_colour ="blue",
                     title=map_title,
                     perc_bin = TRUE)
  

```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### Level of pay

``` {r la pay level, echo=FALSE, out.width='100%',fig.cap = figure_cap}

    # Produces interactive and static map of boroughs with change in payrolled employees
    
  ## The below produces both a markdown interactive Leaflet map and a static GGPLOT map ##
  paye_la_pay_level_map_data <- paye_la_pay_map_data %>% 
    mutate(tooltip = paste0("Level: £",value_form(measure_value,s=4)))

  # All necessary variables for map
  map_title <- paste0("Nominal median pay","<br>" ,"level (£)")
  map_title_static <- paste0("Nominal median pay, level (£)")
  figure_cap <- paste0("Source: HM Revenue and Customs - Pay As You Earn Real Time Information. Contains Ordnance Survey data Crown copyright and database rights [2015].","<br>","<br>", "Note: Estimates are based on where employees live.")
  
  # Run static map
  paye_la_pay_level_map <- ggplot_map_output(dataset=paye_la_pay_level_map_data,
                                       dt_var="measure_value",
                                       bin_rounding = 200,
                                       diverge_scale = FALSE,
                                       pal_colour = "blue",
                                       title=map_title_static,
                                       perc_bin = FALSE,
                                       chart_name="paye_la_pay_level_map",
                                       caption_txt=figure_cap)
  
  # Run interactive map and output to markdown
  leaflet_map_output(dataset=paye_la_pay_level_map_data,
                     dt_var="measure_value",
                     bin_rounding = 500,
                     diverge_scale = FALSE,
                     pal_colour ="blue",
                     title=map_title,
                     perc_bin = FALSE)
  

```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>



## LA cross-variable trends {.tabset}

### Pay growth vs. level

``` {r, paye LA pay trend, echo=FALSE, out.width='100%',fig.cap = figure_cap}


  # select month which to use as comparison level, e.g. February 2020
  paye_la_pay_comp_month <- as.Date("2020-02-01")
  paye_la_pay_comp_month_form <- format(paye_la_pay_comp_month,"%B %Y")
  
  # Need employee and pay stats simultaneously so reshape wide
  
  paye_la_bubble_stats <- paye_la_stats %>% 
    bind_rows(paye_stats)   %>%  #add London and UK
    group_by(geography_name,measure_name)   %>% # for within-LA stats
    mutate(measure_value_comp_month = measure_value[date_day==paye_la_pay_comp_month]) %>% 
    ungroup() %>% 
    pivot_wider(names_from=measure_name,
                values_from = c(measure_value,measure_value_comp_month,contains("_change"),index_feb20),
                names_glue = "{measure_name}_{.value}") %>% 
    arrange(date_day,geography_name)
  
  # Chart functions
  pal <- gla_pal(n=1)
  pal_lines <- gla_pal(n=1,main_colours = "ldnpink")
  
  # Bubbles are size of industry employees, values are growth vs. level in pay
  # Have straight lines indicate London averages
  paye_la_pay_v_pay <- paye_la_bubble_stats %>% 
    filter(date_day==paye_la_last_date & geography_name!="UK") %>% 
    ggplot() +
    geom_point(data = . %>% filter(!(geography_name %in% c("London","City of London"))),
               aes(x=median_pay_measure_value_comp_month,
                   y=median_pay_p_change_feb20,
                   size=emps_measure_value,
                   text= paste0(geography_name,"\n",
                                "Feb '20 pay level: £",value_form(median_pay_measure_value_comp_month),"\n",
                                "Pay growth: ",perc_form(100*median_pay_p_change_feb20),"%","\n",
                                "Employees: ",value_form(emps_measure_value))),
               color=pal,
               fill=pal,
               alpha=0.6)+
    scale_size(range = c(3, 10)) +
    geom_vline(data = . %>% filter(geography_name=="London"),
               aes(xintercept = median_pay_measure_value_comp_month),
               size = 1 * mm_to_pt,
               colour = pal_lines) + # median london wage
    geom_hline(data = . %>% filter(geography_name=="London"),
               aes(yintercept = median_pay_p_change_feb20),
               size = 1 * mm_to_pt,
               colour = pal_lines) + # median london wage change
    coord_cartesian(clip = 'off') +
    scale_y_continuous(expand = expansion( mult = c(0,0.05)), 
                       labels = percent_format(accuracy = 1),
                       limits = c(0.09,0.16)) +
    scale_x_continuous(expand = expansion( mult = c(0.05,0.05)),
                       labels = comma_format(prefix = "£")) +
    theme(legend.position = "none",
          plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  paste0("Median pay level vs. median pay growth, ",paye_la_pay_comp_month_form,", London boroughs"),
         subtitle = paste0("Growth to ",paye_ind_last_month,"; bubble size represents employees in borough"),
         caption = paste0("\nSource: HM Revenue and Customs - Pay As You Earn Real Time Information.",
                          "\n\nNote: Estimates are based on where employees live. Excludes City of London.",
                          "\nVertical line indicates level of median pay in London in ",paye_la_pay_comp_month_form,",","\nhorizontal line indicates change in London median pay ",paye_la_pay_comp_month_form,"-",paye_ind_last_month))+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  # Add text labels separately as plotly does not support them
  paye_la_pay_v_pay_static <- paye_la_pay_v_pay +
    geom_text_repel(data = . %>% filter(!(geography_name %in% c("London","City of London"))),
                    aes(x=median_pay_measure_value_comp_month,
                        y=median_pay_p_change_feb20,
                        label = geography_name),
                    seed=1,
                    box.padding   = 0.8, 
                    point.padding = 0.6,
                    segment.color = 'grey50')
  
  
  # Save chart
  save_GLA_plot(plot_name = "paye_la_pay_v_pay_static",w=10, h=7)
  
  # Plotly chart
  LMU_plotly_settings(ch_name = paye_la_pay_v_pay,
                      title_text = 'paste0("Median pay level vs. median pay growth, ",paye_la_pay_comp_month_form,", London boroughs")',
                      subtitle_text = 'paste0("Growth to ",paye_ind_last_month,"; bubble size represents employees in borough")',
                      hover_mode = "closest")
  
  figure_cap <- paste0("Source: HM Revenue and Customs - Pay As You Earn Real Time Information.",
                          "<br>","<br>","Note: Estimates are based on where employees live. Excludes City of London.","<br>","Vertical line indicates level of median pay in London in ",paye_ind_pay_comp_month_form,",","<br>","horizontal line indicates change in London median pay ",paye_ind_pay_comp_month_form,"-",paye_ind_last_month)



```

<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>


### Emp growth vs pay growth

``` {r, paye la pay_emp trend, echo=FALSE, out.width='100%',fig.cap = figure_cap}


# Chart functions
pal <- gla_pal(n=1)
pal_lines <- gla_pal(n=1,main_colours = "ldnpink")


# Bubbles are size of industry employees, values are growth vs. level in pay
  # Have straight lines indicate London averages
  paye_la_emp_v_pay <- paye_la_bubble_stats %>% 
    filter(date_day==paye_la_last_date & geography_name!="UK") %>% 
    ggplot() +
    geom_point(data = . %>% filter(!(geography_name %in% c("London","City of London"))),
               aes(x=emps_p_change_feb20,
                   y=median_pay_p_change_feb20,
                   size=emps_measure_value,
                   text= paste0(geography_name,"\n",
                                "Employee growth: ",perc_form(100*emps_p_change_feb20),"%","\n",
                                "Pay growth: ",perc_form(100*median_pay_p_change_feb20),"%","\n",
                                "Employees: ",value_form(emps_measure_value))),
               color=pal,
               fill=pal,
               alpha=0.6)+
    scale_size(range = c(3, 10)) +
    geom_vline(data = . %>% filter(geography_name=="London"),
               aes(xintercept = emps_p_change_feb20),
               size = 1 * mm_to_pt,
               colour = pal_lines) + # median london wage
    geom_hline(data = . %>% filter(geography_name=="London"),
               aes(yintercept = median_pay_p_change_feb20),
               size = 1 * mm_to_pt,
               colour = pal_lines) + # median london wage change
    coord_cartesian(clip = 'off') +
    scale_y_continuous(expand = expansion( mult = c(0,0.05)), 
                       labels = percent_format(accuracy = 1),
                       limits = c(0.09,0.16)) +
    scale_x_continuous(expand = expansion( mult = c(0.05,0.05)),
                       labels = percent_format(accuracy = 1)) +
    theme(legend.position = "none",
          plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  paste0("Employee growth vs. median pay growth, London boroughs"),
         subtitle = paste0("Growth from ",paye_la_pay_comp_month_form, " to ",paye_la_last_month ,"; bubble size represents employees in borough"),
         caption = paste0("\nSource: HM Revenue and Customs - Pay As You Earn Real Time Information.",
                          "\n\nNote: Estimates are based on where employees live. Excludes City of London.",
                          "\nVertical line indicates level of median pay in London in ",paye_la_pay_comp_month_form,",","\nhorizontal line indicates change in London median pay ",paye_la_pay_comp_month_form,"-",paye_ind_last_month))+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  # Add text labels separately as plotly does not support them
  paye_la_emp_v_pay_static <- paye_la_emp_v_pay +
    geom_text_repel(data = . %>% filter(!(geography_name %in% c("London","City of London"))),
                    aes(x=emps_p_change_feb20,
                        y=median_pay_p_change_feb20,
                        label = geography_name),
                    seed=1,
                    box.padding   = 0.8, 
                    point.padding = 0.6,
                    segment.color = 'grey50')
  
  
  # Save chart
  save_GLA_plot(plot_name = "paye_la_emp_v_pay_static",w=12, h=5)
  
  # Plotly chart
  LMU_plotly_settings(ch_name = paye_la_emp_v_pay,
                      title_text = 'paste0("Employee growth vs. median pay growth, London boroughs")',
                      subtitle_text = 'paste0("Growth from ",paye_la_pay_comp_month_form, " to ",paye_la_last_month ,"; bubble size represents employees in borough")',
                      hover_mode = "closest")
  
  # Caption
  figure_cap <- paste0("Source: HM Revenue and Customs - Pay As You Earn Real Time Information.",
                          "<br>","<br>","Note: Estimates are based on where employees live. Excludes City of London.","<br>","Vertical line indicates level of median pay in London in ",paye_ind_pay_comp_month_form,",","<br>","horizontal line indicates change in London median pay ",paye_ind_pay_comp_month_form,"-",paye_ind_last_month)


```

<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>


## Age groups {.tabset}

### Change since February 2020

``` {r age group feb20, echo=FALSE, out.width='100%',fig.cap = figure_cap}

  pal_named <- setNames(gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1)),
                        nm=c("London","UK"))

  paye_age_pay_feb20 <- paye_nuts1age_stats %>%
    group_by(geography_name, measure_name) %>% 
    filter( date_day == paye_age_last_date & !(age_group %in% c("Aged: 0-17")) & geography_name %in% c("London", "UK") & measure_name=="median_pay" ) %>%  
    mutate(chart_ranking = rank((age_group))) %>% 
    ungroup() %>% 
    ggplot(mapping = aes(x = reorder(age_group,chart_ranking), 
                         y = p_change_feb20, 
                         colour = geography_name , fill=geography_name,
                         text = paste(age_group, "\n",
                                      geography_name, "\n",
                                      "Change: ", perc_form(100*p_change_feb20),"%", "\n",
                                      sep = ""))) +
    geom_bar(stat = "identity", position = position_dodge(), width = 0.4)+
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_colour_manual(values = pal_named) +
    scale_fill_manual(values = pal_named) +
    theme_set(theme_gla(gla_theme = "default")) +
    scale_y_continuous(limits = c(-0.02, 0.25), labels = percent_format(accuracy=1)) +
    theme(axis.text.x = element_text( hjust=1, vjust=0.5)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title = "Nominal median pay by age group, % change",
         subtitle = paste0("Payrolled employee pay, between February 2020 and ", paye_age_last_month),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live.") +
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye_age_pay_feb20")
  
  LMU_plotly_settings(ch_name = paye_age_pay_feb20,
                      title_text = 'paste0("Nominal median pay by age group, % change")',
                      subtitle_text = 'paste0("Payrolled employee pay, between February 2020 and ", paye_age_last_month)',
                      hover_mode = "closest") 
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.<br><br>Note: Estimates are based on where employees live.")


```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### Change on year

``` {r age group yoy, echo=FALSE, out.width='100%',fig.cap = figure_cap}

  pal_named <- setNames(gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1)),
                        nm=c("London","UK"))

  paye_age_pay_feb20 <- paye_nuts1age_stats %>%
    group_by(geography_name, measure_name) %>% 
    filter( date_day == paye_age_last_date & !(age_group %in% c("Aged: 0-17")) & geography_name %in% c("London", "UK") & measure_name=="median_pay" ) %>%  
    mutate(chart_ranking = rank((age_group))) %>% 
    ungroup() %>% 
    ggplot(mapping = aes(x = reorder(age_group,chart_ranking), 
                         y = p_change_yoy, 
                         colour = geography_name , fill=geography_name,
                         text = paste(age_group, "\n",
                                      geography_name, "\n",
                                      "Change: ", perc_form(100*p_change_yoy),"%", "\n",
                                      sep = ""))) +
    geom_bar(stat = "identity", position = position_dodge(), width = 0.4)+
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_colour_manual(values = pal_named) +
    scale_fill_manual(values = pal_named) +
    theme_set(theme_gla(gla_theme = "default")) +
    scale_y_continuous(limits = c(0, 0.1), labels = percent_format(accuracy=1)) +
    theme(axis.text.x = element_text( hjust=1, vjust=0.5)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title = "Nominal median pay by age group, % change on year",
         subtitle = paste0("Payrolled employee pay, ", paye_age_last_month),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live.") +
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye_age_pay_feb20")
  
  LMU_plotly_settings(ch_name = paye_age_pay_feb20,
                      title_text = 'paste0("Nominal median pay by age group, % change on year")',
                      subtitle_text = 'paste0("Payrolled employee pay, ", paye_age_last_month)',
                      hover_mode = "closest") 
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.<br><br>Note: Estimates are based on where employees live.")


```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### Median level

``` {r age group pay level, echo=FALSE, out.width='100%',fig.cap = figure_cap}

  pal_named <- setNames(gla_pal(gla_theme = "default", palette_type = "categorical", n = 1),
                        nm=c("London"))
  scale_size <- c("London"= 1* mm_to_pt)
  
  # Below would allow both UK and London lines, but makes charts less interesting due to scales
  #  pal_named <- setNames(gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1)),
  #                       nm=c("London","UK"))
  # scale_size <- c("London"= 1* mm_to_pt,"UK"= 0.8* mm_to_pt)

  # Set temporarily for flexible y-axes
  theme_set(theme_gla(gla_theme = gla_theme_type,
                      free_y_facets = TRUE))
  
  # Produce chart
  paye_age_pay_level <- paye_nuts1age_stats %>% group_by(geography_name, measure_name) %>% 
      filter( (date_day >= as.Date("2020-01-01")) & !(age_group %in% c("Aged: 0-17")) & geography_name %in% c("London") & measure_name=="median_pay" ) %>%  
      mutate(chart_ranking = rank((age_group))) %>% 
    ggplot(mapping = aes(text = paste(
      format(date_day,"%b-%Y"), "\n",
      "Level: £", value_form(measure_value,s=4,d=1),"\n",
      sep = ""))) +
    ggla_line(aes(x = date_day,
                  y = measure_value, 
                  group = geography_name,
                  colour = geography_name,
                  size = geography_name)) +
    facet_wrap( ~ reorder(age_group,chart_ranking), ncol=3, scales="free")    +
    scale_colour_manual(values = pal_named) +
    scale_size_manual(values = scale_size) +
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    coord_cartesian(clip = 'off') +
    scale_y_continuous(labels = comma_format(prefix="£")) +
    scale_x_date(date_labels = "'%y",date_breaks = "1 year" ) +
    theme() %>% 
    labs(title = paste0("Nominal median pay by age group, level (£)"),
         subtitle = paste0("Payrolled employee pay, ", paye_age_last_month),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live.") +
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)),
          plot.margin = unit(c(1,1,1,1), "cm"),
          panel.spacing = unit(1,"lines"))

  save_GLA_plot(plot_name = "paye_age_pay_level")
  
  # The actual plot
  ggplotly(paye_age_pay_level,tooltip = "text")    %>% 
    ggla_plotly_settings() %>% 
    layout(title = list(text = paste0("<b>","Nominal median pay by age group, level (£)","</b>",
                                      "<br>",
                                      "<sup>",
                                      paste0("Payrolled employee pay, latest data for ", paye_age_last_month),
                                      "</sup>",
                                      "<br>"),
                        font = list(size = 22),
                        y = .95, xref = "plot"),
           xaxis = list(tickfont = list(size = 13)),
           yaxis = list(tickfont = list(size = 13)),
           legend = list(font = list(size = 15),title=list(text="")),
           hovermode = "closest") %>% 
    plotly_modebar() %>%  
    correct_facets(max_fac_num = 6) %>% 
    hide_legend()
  
  # Revert the theme to non-flexible facets
  theme_set(theme_gla(gla_theme = gla_theme_type,
                      free_y_facets = FALSE))
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.<br><br>Note: Estimates are based on where employees live.")


```

<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### Median pay index

``` {r age group pay index, echo=FALSE, out.width='100%',fig.cap = figure_cap}

  pal_named <- setNames(gla_pal(gla_theme = "default", palette_type = "categorical", n = 1),
                        nm=c("London"))
  scale_size <- c("London"= 1* mm_to_pt)
  
  # Below would allow both UK and London lines, but makes charts less interesting due to scales
  #  pal_named <- setNames(gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1)),
  #                       nm=c("London","UK"))
  # scale_size <- c("London"= 1* mm_to_pt,"UK"= 0.8* mm_to_pt)
  
  # Produce chart
  paye_age_pay_index <- paye_nuts1age_stats %>% group_by(geography_name, measure_name) %>% 
      filter( (date_day >= as.Date("2020-01-01")) & !(age_group %in% c("Aged: 0-17")) & geography_name %in% c("London") & measure_name=="median_pay" ) %>%  
      mutate(chart_ranking = rank((age_group))) %>% 
    ggplot(mapping = aes(text = paste(
      format(date_day,"%b-%Y"), "\n",
      "Index: ", value_form(index_feb20,s=3,d=0),"\n",
      sep = ""))) +
    ggla_line(aes(x = date_day,
                  y = index_feb20, 
                  group = geography_name,
                  colour = geography_name,
                  size = geography_name)) +
    facet_wrap( ~ reorder(age_group,chart_ranking), ncol=3, scales="free")    +
    scale_colour_manual(values = pal_named) +
    scale_size_manual(values = scale_size) +
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    coord_cartesian(clip = 'off') +
    scale_y_continuous(labels = comma_format(),
                       limits=c(88,126)) +
    scale_x_date(date_labels = "'%y",date_breaks = "1 year" ) +
    theme() %>% 
    labs(title = paste0("Nominal median pay by age group, indexed to Feb 2020"),
         subtitle = paste0("Payrolled employee pay, ", paye_age_last_month),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live.") +
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)),
          plot.margin = unit(c(1,1,1,1), "cm"),
          panel.spacing = unit(1,"lines"))

  save_GLA_plot(plot_name = "paye_age_pay_index")
  
  # The actual plot
  ggplotly(paye_age_pay_index,tooltip = "text")    %>% 
    ggla_plotly_settings() %>% 
    layout(title = list(text = paste0("<b>","Nominal median pay by age group, indexed to Feb 2020","</b>",
                                      "<br>",
                                      "<sup>",
                                      paste0("Payrolled employee pay, latest data for ", paye_age_last_month),
                                      "</sup>",
                                      "<br>"),
                        font = list(size = 22),
                        y = .95, xref = "plot"),
           xaxis = list(tickfont = list(size = 13)),
           yaxis = list(tickfont = list(size = 13)),
           legend = list(font = list(size = 15),title=list(text="")),
           hovermode = "closest") %>% 
    plotly_modebar() %>%  
    correct_facets(max_fac_num = 6) %>% 
    hide_legend()

  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.<br><br>Note: Estimates are based on where employees live.")


```

<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

## NUTS2 Regions {.tabset}

### Change since February 2020

``` {r nuts2 feb2020, echo=FALSE, out.width='100%'}

  # Palette: five subregions, one London, one UK
  pal <- c(rep(gla_pal(gla_theme = "default", palette_type = "categorical", n = 1),5),
           gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1)))
  pal_text <- c(rep("white",6),"black")

  paye_nuts2_pay_feb20 <- paye_nuts2_stats %>%
    filter(date_day == max(date_day) & measure_name=="median_pay") %>%
    mutate(chart_ranking = case_when( geography_name == "UK" ~ 1,
                                      geography_name == "London" ~ 2,
                                      TRUE ~ dense_rank(desc(p_change_feb20))+2)) %>% 
    ggplot(mapping = aes(x =  reorder(geography_name, -chart_ranking), y = p_change_feb20,
                         group = geography_name,
                         fill=geography_name,
                         text = paste0(
                           geography_name, "\n",
                           "Change: ", perc_form(100*p_change_feb20),"%", "\n"))) +
    geom_bar(aes(width=0.5), 
             stat="identity")+
    geom_text(aes(label=paste0(value_form(100*p_change_feb20,d=1,s=3), "%"),
                  y = p_change_feb20-0.01*((p_change_feb20)/abs(p_change_feb20)),
                  colour=geography_name)) + 
    scale_color_manual(values = pal_text, aesthetics = "colour") +
    scale_fill_manual(values = pal, aesthetics =  "fill") +
    coord_cartesian(clip = 'off') +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_y_continuous(labels = percent_format(accuracy=1),
                       limits = c(0,0.15)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"),axis.text=element_text(size=12))+
    labs(title =  "Nominal median pay by NUTS2 region, % change",
         subtitle = paste0("Payrolled employees, between February 2020 and ", paye_overall_last_month),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live.") + 
    theme(legend.position = "none",
          plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  
  save_GLA_plot(plot_name = "paye_nuts2_pay_feb20")
  
  LMU_plotly_settings(ch_name = paye_nuts2_pay_feb20,
                      title_text = 'paste0("Nominal median pay by NUTS2 region, % change")',
                      subtitle_text = 'paste0("Payrolled employee pay, between February 2020 and ",
                      paye_overall_last_month)',
                      hover_mode = "closest") %>% 
    hide_legend()
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.<br><br>Note: Estimates are based on where employees live.")


```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

### Change on year

``` {r nuts2 pay comp yoy, echo=FALSE, out.width='100%'}

  # Palette: five subregions, one London, one UK
  pal <- c(rep(gla_pal(gla_theme = "default", palette_type = "categorical", n = 1),5),
           gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1)))
  pal_text <- c(rep("white",6),"black")

  paye_nuts2_pay_yoy <- paye_nuts2_stats %>%
    filter(date_day == max(date_day) & measure_name=="median_pay") %>%
    mutate(chart_ranking = case_when( geography_name == "UK" ~ 1,
                                      geography_name == "London" ~ 2,
                                      TRUE ~ dense_rank(desc(p_change_yoy))+2)) %>% 
    ggplot(mapping = aes(x =  reorder(geography_name, -chart_ranking), y = p_change_yoy,
                         group = geography_name,
                         fill=geography_name,
                         text = paste0(
                           geography_name, "\n",
                           "Change: ", perc_form(100*p_change_yoy),"%", "\n"))) +
    geom_bar(aes(width=0.5), 
             stat="identity")+
    geom_text(aes(label=paste0(value_form(100*p_change_yoy,d=1,s=3), "%"),
                  y = p_change_yoy-0.005*((p_change_yoy)/abs(p_change_yoy)),
                  colour=geography_name)) + 
    scale_color_manual(values = pal_text, aesthetics = "colour") +
    scale_fill_manual(values = pal, aesthetics =  "fill") +
    coord_cartesian(clip = 'off') +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_y_continuous(labels = percent_format(accuracy=1),
                       limits = c(0,0.08)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"),axis.text=element_text(size=12))+
    labs(title =  "Nominal median pay by NUTS2 region, % change on year",
         subtitle = paste0("Payrolled employees, ", paye_overall_last_month),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live.") + 
    theme(legend.position = "none",
          plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  
  save_GLA_plot(plot_name = "paye_nuts2_pay_yoy")
  
  LMU_plotly_settings(ch_name = paye_nuts2_pay_yoy,
                      title_text = 'paste0("Nominal median pay by NUTS2 region, % change on year")',
                      subtitle_text = 'paste0("Payrolled employee pay, ",
                      paye_overall_last_month)',
                      hover_mode = "closest") %>% 
    hide_legend()
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.<br><br>Note: Estimates are based on where employees live.")


```
<br/>

<a href="#top">Back to top</a>

<br/>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>


## Level of real median pay long

``` {r long real median pay, echo=FALSE, out.width='100%',fig.cap = figure_cap}

  lt_pay_data <- cpih_pay_stats %>%
    filter(pay_type=="real" & date_day>=as.Date("2019-01-01")) 
  
  named_groups <- c("London","United Kingdom")
  pal <- gla_pal(palette_type = "highlight",n=c(1,1)) 
  pal_named <- setNames(object=pal,nm=named_groups)
  
  max_y <- max(lt_pay_data %>% pull(pay_index_jan19))
  min_y <- min(lt_pay_data %>% pull(pay_index_jan19))
  
  lt_real_pay_line <- lt_pay_data%>% 
    ggplot(mapping = aes(x = date_day, y = pay_index_jan19, 
                         colour = geography_name, 
                         group = geography_name,
                         text = paste0(
                           geography_name, "\n",
                           format(date_day,'%B %Y'), "\n",
                           "Real pay index: ", value_form(pay_index_jan19,s=3,d=0), "\n"))) +
    ggla_line(aes(size= geography_name)) +
    scale_size_manual(values = c(2 * mm_to_pt, 1 * mm_to_pt)) +
    scale_colour_manual(values = pal_named) +
    ggla_highlight(filter_type = "end") +
    ggla_highlight(mapping = aes(label = value_form(pay_index_jan19,s=3,d=0)),
                   geom = GeomGLATextHighlight, filter_type = "end",  size = 4.5,
                   position = position_nudge(y = c(0,0)),
                   check_overlap = TRUE)+
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    coord_cartesian(clip = 'off') +
    scale_y_continuous(expand = c(0, 0), 
                       limits = c(max_y-3/2*(max_y-min_y),max_y),
                       labels = comma_format(accuracy=1)) +
    scale_x_date( date_breaks = "1 year",
                  date_labels = "%b %Y",
                  expand = expansion( mult = c(0.05,0.05))) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  "Level of real median pay since 2019",
         subtitle = paste0("Nominal pay adjusted for inflation, to ",cpih_last_month_form),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.\n\nNote: March 2020 indicated by dotted line.")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "lt_real_pay_line")
  
  # Plotly chart
  LMU_plotly_settings(ch_name = lt_real_pay_line,
                      title_text = 'paste0("Level of real median pay since 2019")',
                      subtitle_text = 'paste0("Nominal pay adjusted for inflation, to ",cpih_last_month_form)',
                      hover_mode = "x unified")
  
  figure_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information, ONS.","<br>","<br>", "Note: March 2020 indicated by dotted line. Inflation measure does not account for region-specific price changes. Sign of inflation rates has been reversed (higher inflation rates are associated with lower real pay growth).")

```
<br/>

<a href="#top">Back to top</a>

</font>

::: {.tocify-extend-page data-unique="tocify-extend-page" style="height: 0;"}
:::
